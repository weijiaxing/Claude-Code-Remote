# 飞书集成指南

本指南详细介绍如何配置和使用 Claude Code Remote 的飞书通知功能。

## 🚀 快速开始

### 1. 创建飞书机器人

#### 步骤 1: 进入群聊设置
1. 打开需要接收通知的飞书群聊
2. 点击群聊右上角的设置图标
3. 选择 "机器人" 选项

#### 步骤 2: 添加自定义机器人
1. 点击 "添加机器人"
2. 选择 "自定义机器人"
3. 填写机器人信息：
   - **名称**: Claude Code Remote
   - **描述**: Claude Code 任务完成通知机器人
   - **头像**: 可选择上传自定义头像

#### 步骤 3: 配置安全设置
1. **Webhook URL**: 系统会自动生成，请复制保存
2. **签名验证** (推荐启用):
   - 勾选 "启用签名验证"
   - 复制生成的签名密钥
   - 这将提高通知的安全性

#### 步骤 4: 完成创建
1. 点击 "完成" 创建机器人
2. 机器人会自动加入群聊
3. 记录 Webhook URL 和签名密钥

### 2. 配置环境变量

在项目根目录的 `.env` 文件中添加以下配置：

```env
# 飞书机器人 Webhook URL (必需)
FEISHU_WEBHOOK=https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

# 飞书机器人签名密钥 (可选，但推荐)
FEISHU_SECRET=your-signature-secret-key

# 启用飞书通知
FEISHU_ENABLED=true
```

### 3. 使用配置工具

```bash
# 运行交互式配置工具
node src/config-manager.js

# 选择选项 2: Configure Feishu (飞书)
# 按提示输入配置信息
```

### 4. 测试配置

```bash
# 测试飞书通知
node test-feishu.js
```

如果配置正确，您应该在飞书群聊中看到一条测试消息。

## 📋 通知消息格式

### 任务完成通知

当 Claude 完成任务时，飞书会收到如下格式的卡片消息：

```
┌─────────────────────────────────────┐
│ ✅ Claude Code - 任务完成            │
├─────────────────────────────────────┤
│ 项目: my-project    会话: #ABC12345  │
│ 状态: 任务完成      时间: 2025-01-08 │
├─────────────────────────────────────┤
│ 📝 用户问题:                        │
│ 请分析这个函数的性能问题              │
│                                     │
│ 🤖 Claude 响应:                     │
│ 我已经分析了函数的性能，发现了几个    │
│ 可以优化的地方...                   │
├─────────────────────────────────────┤
│ 💡 如需继续对话，请使用邮件回复功能   │
│                                     │
│ [查看详情] [复制会话ID]              │
└─────────────────────────────────────┘
```

### 等待输入通知

当 Claude 需要用户输入时：

```
┌─────────────────────────────────────┐
│ ⏳ Claude Code - 等待输入            │
├─────────────────────────────────────┤
│ 项目: my-project    会话: #ABC12345  │
│ 状态: 等待输入      时间: 2025-01-08 │
├─────────────────────────────────────┤
│ ⏳ 等待处理:                        │
│ Claude 需要您的进一步指导才能继续     │
├─────────────────────────────────────┤
│ 🔔 Claude 需要您的进一步指导才能继续  │
│                                     │
│ [前往终端]                          │
└─────────────────────────────────────┘
```

## 🔧 高级配置

### 自定义通知模板

您可以通过修改 `src/channels/feishu/webhook.js` 中的 `_initCardTemplates()` 方法来自定义通知卡片的样式和内容。

### 签名验证

启用签名验证可以确保通知消息的安全性：

1. **为什么需要签名验证？**
   - 防止恶意请求伪造通知
   - 确保消息来源的可信性
   - 符合企业安全要求

2. **如何启用？**
   - 在创建机器人时勾选 "启用签名验证"
   - 将生成的密钥配置到 `FEISHU_SECRET` 环境变量

3. **签名算法**
   - 使用 HMAC-SHA256 算法
   - 签名字符串格式: `{timestamp}\n{secret}`

### 错误处理

飞书通道包含完善的错误处理机制：

- **网络错误**: 自动重试机制
- **API 错误**: 详细的错误日志
- **配置错误**: 启动时验证配置

## 🎯 最佳实践

### 1. 群聊管理

- **专用群聊**: 建议为 Claude Code Remote 创建专用群聊
- **成员管理**: 只邀请需要接收通知的团队成员
- **权限控制**: 合理设置群聊权限，避免误操作

### 2. 通知频率

- **合理使用**: 避免在短时间内发送大量通知
- **过滤设置**: 可以通过配置文件控制通知类型
- **静音时间**: 考虑在非工作时间禁用通知

### 3. 安全考虑

- **启用签名验证**: 强烈推荐启用签名验证
- **定期更新密钥**: 定期更换签名密钥
- **访问控制**: 限制 Webhook URL 的访问权限

### 4. 监控和维护

- **日志监控**: 定期检查通知发送日志
- **性能监控**: 监控通知发送的成功率和延迟
- **定期测试**: 定期运行测试脚本验证功能

## 🔍 故障排除

### 常见问题

#### 1. 通知发送失败

**症状**: 运行 `node test-feishu.js` 报错

**解决方案**:
```bash
# 检查网络连接
curl -I https://open.feishu.cn

# 验证 Webhook URL 格式
echo $FEISHU_WEBHOOK

# 检查配置文件
node -e "console.log(require('dotenv').config())"
```

#### 2. 签名验证失败

**症状**: 飞书显示 "签名验证失败"

**解决方案**:
- 确认 `FEISHU_SECRET` 配置正确
- 检查系统时间是否准确
- 验证签名算法实现

#### 3. 消息格式异常

**症状**: 飞书收到的消息格式不正确

**解决方案**:
- 检查卡片模板 JSON 格式
- 验证变量替换是否正确
- 查看飞书开发文档的最新格式要求

### 调试模式

启用详细日志进行调试：

```bash
# 设置日志级别为 debug
export LOG_LEVEL=debug

# 运行测试
node test-feishu.js
```

### 联系支持

如果遇到无法解决的问题：

1. 查看项目 [Issues](https://github.com/JessyTsui/Claude-Code-Remote/issues)
2. 提交新的 Issue，包含：
   - 错误信息和日志
   - 配置信息（隐藏敏感数据）
   - 系统环境信息

## 📚 相关资源

- [飞书开放平台文档](https://open.feishu.cn/document/)
- [飞书机器人开发指南](https://open.feishu.cn/document/ukTMukTMukTM/ucTM5YjL3ETO24yNxkjN)
- [Claude Code Remote 项目主页](https://github.com/JessyTsui/Claude-Code-Remote)

## 🔄 双向通信功能

### 启用双向通信

飞书集成现在支持双向通信，您可以直接在飞书群聊中回复命令！

#### 配置步骤

1. **启用事件监听**
   ```bash
   # 在 .env 文件中添加
   FEISHU_EVENTS_ENABLED=true
   FEISHU_EVENT_PORT=3000
   FEISHU_VERIFY_TOKEN=your-verify-token
   ```

2. **飞书开放平台配置**
   - 登录 [飞书开放平台](https://open.feishu.cn/)
   - 创建企业自建应用
   - 在"事件订阅"中配置：
     - 请求URL: `http://your-server:3000/feishu/events`
     - 订阅事件: `im.message.receive_v1`
   - 获取并配置 Verification Token

3. **启动事件监听服务**
   ```bash
   # 统一启动（推荐）
   npm run relay:unified
   
   # 或单独启动飞书服务
   npm run relay:feishu
   ```

#### 使用方法

在飞书群聊中发送命令：

```
会话 #ABC12345 请优化这个函数的性能
```

**命令格式说明：**
- `会话 #ABC12345`: 指定要操作的会话（从通知卡片中获取）
- 后面跟您要执行的具体命令

**支持的命令示例：**
```
会话 #ABC12345 添加错误处理逻辑

会话 #ABC12345 
请帮我完成以下任务：
1. 重构这个函数
2. 添加单元测试
3. 更新文档

会话 #ABC12345 解释这段代码的作用
```

### 安全特性

- **会话验证**: 只有有效的会话ID才能执行命令
- **权限控制**: 可以配置允许执行命令的用户
- **命令过滤**: 自动过滤危险命令
- **签名验证**: 验证请求来源的合法性

## 🚀 未来计划

- [x] **双向通信**: 支持通过飞书回复命令 ✅
- [ ] **富文本支持**: 更丰富的消息格式
- [ ] **批量通知**: 支持向多个群聊发送通知
- [ ] **模板自定义**: 可视化的消息模板编辑器
- [ ] **统计分析**: 通知发送统计和分析功能
- [ ] **用户权限**: 细粒度的用户权限控制

---

**💡 提示**: 飞书集成是 Claude Code Remote 的增强功能，与邮件通知互补使用效果更佳！